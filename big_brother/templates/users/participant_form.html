{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}{% if is_create %}Create New Participant{% else %}Edit Participant: {{ participant.nickname }}{% endif %}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">
            {% if is_create %}Create New Participant{% else %}Edit Participant: {{ participant.nickname }}{% endif %}
        </h1>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% if form.errors or phone_formset.errors or email_formset.errors %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Please correct the following errors:</strong>
            <ul class="mb-0">
                {% for field in form %}
                    {% for error in field.errors %}
                        <li>{{ field.label }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
                {% for form in phone_formset %}
                    {% for error in form.errors %}
                        <li>Phone {{ forloop.parentloop.counter }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
                {% for form in email_formset %}
                    {% for error in form.errors %}
                        <li>Email {{ forloop.parentloop.counter }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}
    </div>
</div>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Basic Information Card -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0"><i class="fas fa-user-circle me-2"></i>Basic Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_username" class="form-label fw-bold">Username*</label>
                        {% render_field form.username class="form-control" placeholder="Enter username" %}
                        {% if form.username.errors %}
                        <div class="text-danger small mt-1">{{ form.username.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_nickname" class="form-label fw-bold">Nickname*</label>
                        {% render_field form.nickname class="form-control" placeholder="Enter nickname" %}
                        {% if form.nickname.errors %}
                        <div class="text-danger small mt-1">{{ form.nickname.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_first_name" class="form-label fw-bold">First Name</label>
                        {% render_field form.first_name class="form-control" placeholder="Enter first name" %}
                        {% if form.first_name.errors %}
                        <div class="text-danger small mt-1">{{ form.first_name.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_last_name" class="form-label fw-bold">Last Name</label>
                        {% render_field form.last_name class="form-control" placeholder="Enter last name" %}
                        {% if form.last_name.errors %}
                        <div class="text-danger small mt-1">{{ form.last_name.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

 {% if is_create %}
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_password" class="form-label fw-bold">Password*</label>
                        {% render_field form.password class="form-control" placeholder="Enter password" %}
                        {% if form.password.errors %}
                        <div class="text-danger small mt-1">{{ form.password.errors }}</div>
                        {% endif %}
                        <div class="form-text">{{ form.password.help_text }}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_confirm_password" class="form-label fw-bold">Confirm Password*</label>
                        {% render_field form.confirm_password class="form-control" placeholder="Confirm password" %}
                        {% if form.confirm_password.errors %}
                        <div class="text-danger small mt-1">{{ form.confirm_password.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_password" class="form-label fw-bold">Password</label>
                        <input type="password" name="password" class="form-control" placeholder="Leave empty to keep current password" value="">
                        {% if form.password.errors %}
                        <div class="text-danger small mt-1">{{ form.password.errors }}</div>
                        {% endif %}
                        <div class="form-text">{{ form.password.help_text }}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_confirm_password" class="form-label fw-bold">Confirm Password</label>
                        <input type="password" name="confirm_password" class="form-control" placeholder="Confirm password" value="">
                        {% if form.confirm_password.errors %}
                        <div class="text-danger small mt-1">{{ form.confirm_password.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_avatar" class="form-label fw-bold">Avatar</label>
                        {% render_field form.avatar class="form-control" %}
                        {% if form.avatar.errors %}
                        <div class="text-danger small mt-1">{{ form.avatar.errors }}</div>
                        {% endif %}
                        {% if participant.avatar %}
                        <div class="mt-2">
                            <img src="{{ participant.avatar.url }}" alt="Current avatar" class="img-thumbnail" width="100">
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status & Role Card -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-info text-white">
            <h5 class="card-title mb-0"><i class="fas fa-user-tag me-2"></i>Status & Role</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="id_status" class="form-label fw-bold">Status</label>
                        {% render_field form.status class="form-select" %}
                        {% if form.status.errors %}
                        <div class="text-danger small mt-1">{{ form.status.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="id_date_inactive" class="form-label fw-bold">Date Inactive</label>
                        {% render_field form.date_inactive class="form-control" %}
                        {% if form.date_inactive.errors %}
                        <div class="text-danger small mt-1">{{ form.date_inactive.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="id_role" class="form-label fw-bold">Role</label>
                        {% render_field form.role class="form-select" %}
                        {% if form.role.errors %}
                        <div class="text-danger small mt-1">{{ form.role.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="id_assigned_by" class="form-label fw-bold">Assigned By</label>
                        {% render_field form.assigned_by class="form-select" %}
                        {% if form.assigned_by.errors %}
                        <div class="text-danger small mt-1">{{ form.assigned_by.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Historical Information Card -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-warning text-dark">
            <h5 class="card-title mb-0"><i class="fas fa-history me-2"></i>Historical Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Activity</label>
                        <input type="text" name="activity" class="form-control" placeholder="Enter current activity"
                               value="{{ current_activity }}">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Activity Address</label>
                        <input type="text" name="activity_address" class="form-control" placeholder="Enter activity address"
                               value="{{ current_activity_address }}">
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Job</label>
                        <input type="text" name="job" class="form-control" placeholder="Enter job title"
                               value="{{ current_job }}">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Job Address</label>
                        <input type="text" name="job_address" class="form-control" placeholder="Enter job address"
                               value="{{ current_job_address }}">
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Address</label>
                        <textarea name="address" class="form-control" rows="3" placeholder="Enter current address">{{ current_address }}</textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Phone Numbers Card -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0"><i class="fas fa-phone me-2"></i>Phone Numbers</h5>
        </div>
        <div class="card-body">
            {{ phone_formset.management_form }}
            <div id="phone-formset">
                {% for form in phone_formset %}
                <div class="row form-row mb-3 align-items-end phone-row {% if form.errors %}border border-danger rounded p-2{% endif %}">
                    <div class="col-md-10">
                        <label class="form-label fw-bold">Phone Number</label>
                        {% render_field form.number class="form-control phone-input" placeholder="+1234567890" %}
                        {% if form.number.errors %}
                        <div class="text-danger small mt-1">{{ form.number.errors }}</div>
                        {% endif %}
                        {% if form.non_field_errors %}
                        <div class="text-danger small mt-1">{{ form.non_field_errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-2">
                        {% if form.instance.pk %}
                        <div class="form-check form-switch mb-2">
                            {% render_field form.DELETE class="form-check-input" %}
                            <label class="form-check-label small" for="{{ form.DELETE.id_for_label }}">Delete</label>
                        </div>
                        {% endif %}
                        <button type="button" class="btn btn-danger btn-sm remove-phone" {% if forloop.first and phone_formset.total_form_count == 1 %}style="display: none;"{% endif %}>
                            <i class="fas fa-trash"></i>
                        </button>
                        {{ form.id }}
                    </div>
                </div>
                {% endfor %}
            </div>
            <button type="button" class="btn btn-outline-primary mt-2" id="add-phone">
                <i class="fas fa-plus-circle me-1"></i> Add Another Phone
            </button>
        </div>
    </div>

    <!-- Email Addresses Card -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-purple text-white">
            <h5 class="card-title mb-0"><i class="fas fa-envelope me-2"></i>Email Addresses</h5>
        </div>
        <div class="card-body">
            {{ email_formset.management_form }}
            <div id="email-formset">
                {% for form in email_formset %}
                <div class="row form-row mb-3 align-items-end email-row {% if form.errors %}border border-danger rounded p-2{% endif %}">
                    <div class="col-md-10">
                        <label class="form-label fw-bold">Email Address</label>
                        {% render_field form.email class="form-control email-input" placeholder="email@example.com" %}
                        {% if form.email.errors %}
                        <div class="text-danger small mt-1">{{ form.email.errors }}</div>
                        {% endif %}
                        {% if form.non_field_errors %}
                        <div class="text-danger small mt-1">{{ form.non_field_errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-2">
                        {% if form.instance.pk %}
                        <div class="form-check form-switch mb-2">
                            {% render_field form.DELETE class="form-check-input" %}
                            <label class="form-check-label small" for="{{ form.DELETE.id_for_label }}">Delete</label>
                        </div>
                        {% endif %}
                        <button type="button" class="btn btn-danger btn-sm remove-email" {% if forloop.first and email_formset.total_form_count == 1 %}style="display: none;"{% endif %}>
                            <i class="fas fa-trash"></i>
                        </button>
                        {{ form.id }}
                    </div>
                </div>
                {% endfor %}
            </div>
            <button type="button" class="btn btn-outline-primary mt-2" id="add-email">
                <i class="fas fa-plus-circle me-1"></i> Add Another Email
            </button>
        </div>
    </div>

    <!-- Form Actions -->
    <div class="d-flex justify-content-between mt-4">
        <a href="{% if is_create %}{% url 'users:participant_list' %}{% else %}{% url 'users:participant_detail' participant.id %}{% endif %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Cancel
        </a>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i> Save Changes
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
   // Add error classes to form fields
    {% for field in form %}
        {% if field.errors %}
            document.getElementById('id_{{ field.name }}').classList.add('is-invalid');
        {% endif %}
    {% endfor %}

    // Add error classes to formset fields
    {% for form in phone_formset %}
        {% for field in form %}
            {% if field.errors %}
                document.getElementById('id_{{ field.name }}').classList.add('is-invalid');
            {% endif %}
        {% endfor %}
    {% endfor %}

    {% for form in email_formset %}
        {% for field in form %}
            {% if field.errors %}
                document.getElementById('id_{{ field.name }}').classList.add('is-invalid');
            {% endif %}
        {% endfor %}
    {% endfor %}

    // Phone formset
    const addPhoneButton = document.getElementById('add-phone');
    if (addPhoneButton) {
        addPhoneButton.addEventListener('click', function() {
            // Create the management form if it doesn't exist
            let totalForms = document.getElementById('phone_set-TOTAL_FORMS');
            if (!totalForms) {
                totalForms = document.createElement('input');
                totalForms.type = 'hidden';
                totalForms.name = 'phone_set-TOTAL_FORMS';
                totalForms.id = 'phone_set-TOTAL_FORMS';
                totalForms.value = '0';
                document.querySelector('form').appendChild(totalForms);
            }

            const formNum = parseInt(totalForms.value);
            const formRows = document.querySelectorAll('#phone-formset .phone-row');

            if (formRows.length === 0) return;

            const lastFormRow = formRows[formRows.length - 1];
            const newRow = lastFormRow.cloneNode(true);

            // Update form indices
            newRow.innerHTML = newRow.innerHTML.replace(/phone_set-(\d+)-/g, `phone_set-${formNum}-`);

            // Clear input values
            const numberInput = newRow.querySelector('.phone-input');
            if (numberInput) numberInput.value = '';

            // Show delete button for new rows
            const deleteButton = newRow.querySelector('.remove-phone');
            if (deleteButton) {
                deleteButton.style.display = 'block';
                deleteButton.addEventListener('click', function() {
                    newRow.remove();
                    updatePhoneFormIndices();
                });
            }

            // Hide delete checkbox for new forms
            const deleteCheckbox = newRow.querySelector('input[name$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.style.display = 'none';
                const deleteLabel = newRow.querySelector('label[for="' + deleteCheckbox.id + '"]');
                if (deleteLabel) deleteLabel.style.display = 'none';
            }

            // Clear ID field for new forms
            const idField = newRow.querySelector('input[name$="-id"]');
            if (idField) idField.value = '';

            // Clear error messages
            const errorDiv = newRow.querySelector('.text-danger');
            if (errorDiv) errorDiv.remove();

            // Append new row
            document.getElementById('phone-formset').appendChild(newRow);
            totalForms.value = formNum + 1;

            // Add event listener to the new delete button
            newRow.querySelector('.remove-phone').addEventListener('click', function() {
                newRow.remove();
                updatePhoneFormIndices();
            });
        });
    }

    // Email formset
    const addEmailButton = document.getElementById('add-email');
    if (addEmailButton) {
        addEmailButton.addEventListener('click', function() {
            // Create the management form if it doesn't exist
            let totalForms = document.getElementById('email_set-TOTAL_FORMS');
            if (!totalForms) {
                totalForms = document.createElement('input');
                totalForms.type = 'hidden';
                totalForms.name = 'email_set-TOTAL_FORMS';
                totalForms.id = 'email_set-TOTAL_FORMS';
                totalForms.value = '0';
                document.querySelector('form').appendChild(totalForms);
            }

            const formNum = parseInt(totalForms.value);
            const formRows = document.querySelectorAll('#email-formset .email-row');

            if (formRows.length === 0) return;

            const lastFormRow = formRows[formRows.length - 1];
            const newRow = lastFormRow.cloneNode(true);

            // Update form indices
            newRow.innerHTML = newRow.innerHTML.replace(/email_set-(\d+)-/g, `email_set-${formNum}-`);

            // Clear input values
            const emailInput = newRow.querySelector('.email-input');
            if (emailInput) emailInput.value = '';

            // Show delete button for new rows
            const deleteButton = newRow.querySelector('.remove-email');
            if (deleteButton) {
                deleteButton.style.display = 'block';
                deleteButton.addEventListener('click', function() {
                    newRow.remove();
                    updateEmailFormIndices();
                });
            }

            // Hide delete checkbox for new forms
            const deleteCheckbox = newRow.querySelector('input[name$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.style.display = 'none';
                const deleteLabel = newRow.querySelector('label[for="' + deleteCheckbox.id + '"]');
                if (deleteLabel) deleteLabel.style.display = 'none';
            }

            // Clear ID field for new forms
            const idField = newRow.querySelector('input[name$="-id"]');
            if (idField) idField.value = '';

            // Clear error messages
            const errorDiv = newRow.querySelector('.text-danger');
            if (errorDiv) errorDiv.remove();

            // Append new row
            document.getElementById('email-formset').appendChild(newRow);
            totalForms.value = formNum + 1;

            // Add event listener to the new delete button
            newRow.querySelector('.remove-email').addEventListener('click', function() {
                newRow.remove();
                updateEmailFormIndices();
            });
        });
    }

    // Function to update phone form indices after deletion
    function updatePhoneFormIndices() {
        const formRows = document.querySelectorAll('#phone-formset .phone-row');
        let totalForms = document.getElementById('phone_set-TOTAL_FORMS');

        if (!totalForms) {
            totalForms = document.createElement('input');
            totalForms.type = 'hidden';
            totalForms.name = 'phone_set-TOTAL_FORMS';
            totalForms.id = 'phone_set-TOTAL_FORMS';
            totalForms.value = formRows.length;
            document.querySelector('form').appendChild(totalForms);
        } else {
            totalForms.value = formRows.length;
        }

        formRows.forEach((row, index) => {
            row.querySelectorAll('[name], [id], [for]').forEach(element => {
                if (element.name) {
                    element.name = element.name.replace(/phone_set-(\d+)-/, `phone_set-${index}-`);
                }
                if (element.id) {
                    element.id = element.id.replace(/id_phone_set_(\d+)_/, `id_phone_set_${index}_`);
                }
                if (element.htmlFor) {
                    element.htmlFor = element.htmlFor.replace(/id_phone_set_(\d+)_/, `id_phone_set_${index}_`);
                }
            });

            // Show/hide delete buttons based on row count
            const deleteButton = row.querySelector('.remove-phone');
            if (deleteButton) {
                deleteButton.style.display = formRows.length > 1 ? 'block' : 'none';
            }
        });
    }

    // Function to update email form indices after deletion
    function updateEmailFormIndices() {
        const formRows = document.querySelectorAll('#email-formset .email-row');
        let totalForms = document.getElementById('email_set-TOTAL_FORMS');

        if (!totalForms) {
            totalForms = document.createElement('input');
            totalForms.type = 'hidden';
            totalForms.name = 'email_set-TOTAL_FORMS';
            totalForms.id = 'email_set-TOTAL_FORMS';
            totalForms.value = formRows.length;
            document.querySelector('form').appendChild(totalForms);
        } else {
            totalForms.value = formRows.length;
        }

        formRows.forEach((row, index) => {
            row.querySelectorAll('[name], [id], [for]').forEach(element => {
                if (element.name) {
                    element.name = element.name.replace(/email_set-(\d+)-/, `email_set-${index}-`);
                }
                if (element.id) {
                    element.id = element.id.replace(/id_email_set_(\d+)_/, `id_email_set_${index}_`);
                }
                if (element.htmlFor) {
                    element.htmlFor = element.htmlFor.replace(/id_email_set_(\d+)_/, `id_email_set_${index}_`);
                }
            });

            // Show/hide delete buttons based on row count
            const deleteButton = row.querySelector('.remove-email');
            if (deleteButton) {
                deleteButton.style.display = formRows.length > 1 ? 'block' : 'none';
            }
        });
    }

    // Add event listeners to existing delete buttons
    document.querySelectorAll('.remove-phone').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('.phone-row');
            row.remove();
            updatePhoneFormIndices();
        });
    });

    document.querySelectorAll('.remove-email').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('.email-row');
            row.remove();
            updateEmailFormIndices();
        });
    });

    // Initialize form indices
    updatePhoneFormIndices();
    updateEmailFormIndices();

    // Show/hide date inactive based on status
    const statusField = document.getElementById('id_status');
    const dateInactiveField = document.getElementById('id_date_inactive');

    if (statusField && dateInactiveField) {
        const dateInactiveContainer = dateInactiveField.closest('.mb-3');

        function toggleDateInactiveField() {
            if (statusField.value === 'inactive') {
                dateInactiveContainer.style.display = 'block';
                dateInactiveField.setAttribute('required', 'required');
            } else {
                dateInactiveContainer.style.display = 'none';
                dateInactiveField.removeAttribute('required');
                dateInactiveField.value = '';
            }
        }

        // Initial check
        toggleDateInactiveField();

        // Add event listener
        statusField.addEventListener('change', toggleDateInactiveField);
    }
});

</script>
{% endblock %}
